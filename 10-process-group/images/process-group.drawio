<mxfile host="Electron" modified="2025-01-13T12:51:00.234Z" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/24.2.5 Chrome/120.0.6099.109 Electron/28.1.0 Safari/537.36" etag="yvtlT3cAmNt9ntSHyts9" version="24.2.5" type="device">
  <diagram id="C5RBs43oDa-KdzZeNtuy" name="Page-1">
    <mxGraphModel dx="2931" dy="2230" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-0" />
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-1" parent="WIyWlLk6GJQsqaUBKTNV-0" />
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-0" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Class &lt;font color=&quot;#ff0000&quot;&gt;ProcessGroup&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ instrusive_ptr&amp;lt;Store&amp;gt; store_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ const int rank_; const int size_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ instrusive_ptr&amp;lt;Options&amp;gt; options_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ const BackendType backendType_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ string pg_desc_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ unordered_set&amp;lt;c10::DeviceType&amp;gt; deviceTypes_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ unordered_map&amp;lt;&lt;font color=&quot;#0000ff&quot;&gt;DeviceType&lt;/font&gt;, &lt;font color=&quot;#0000ff&quot;&gt;BackendType&lt;/font&gt;&amp;gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ unordered_map&amp;lt;&lt;font color=&quot;#0000ff&quot;&gt;DeviceType&lt;/font&gt;, instrusive_ptr&amp;lt;&lt;font color=&quot;#0000ff&quot;&gt;Backend&lt;/font&gt;&amp;gt;&amp;gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ unordered_map&amp;lt;&lt;font color=&quot;#0000ff&quot;&gt;BackendType&lt;/font&gt;, instructive_ptr&amp;lt;&lt;font color=&quot;#0000ff&quot;&gt;Backend&lt;/font&gt;&amp;gt;&amp;gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ optional&amp;lt;at::Device&amp;gt; bound_device_id;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ int &lt;font color=&quot;#0000ff&quot;&gt;getRank&lt;/font&gt;();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ int64_t getID() // 返回对象的指针，并转换为int64&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ int64_t getBackendID(BackendType backend_type);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&amp;nbsp; &amp;nbsp; // 调用具体backed的startCoalescing&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual void &lt;font color=&quot;#0000ff&quot;&gt;startCoalescing&lt;/font&gt;(c10::DeviceType);&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual instrusive&amp;lt;Work&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;endCoalescing&lt;/font&gt;(c10::DeviceType);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual c10::instrusive_ptr&amp;lt;Work&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;broadcast/allreduce/&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;&amp;nbsp; &amp;nbsp; allreduce_coalesed/reduce/allgather/_allgather_base/&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;&amp;nbsp; &amp;nbsp; allgather_coalesced/allgather_into_tensor_coalesced/&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;&amp;nbsp; &amp;nbsp; gather/scatter/reduce_scatter/_reduce_scatter_base/&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;&amp;nbsp; &amp;nbsp; reduce_scatter_tensor_coalesced/alltoall_base/all_to_all&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;font color=&quot;#0000ff&quot;&gt;send/recv/recvAnysource/barrier;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual void monitoredBarrier();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual void setSequenceNumberForGroup()&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual uint64_t getSequenceNumberForGroup()&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void &lt;font color=&quot;#0000ff&quot;&gt;setBackend&lt;/font&gt;(DeviceType, BackendType);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ c10::intrusive_ptr&amp;lt;Backend&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;getDefaultBackend&lt;/font&gt;()/getBackend();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ vector&amp;lt;Device&amp;gt; getDeviceTypes();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void registerOncompletionHook();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void waitForPendingWorks();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ bool hasHooks();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ string getGroupName();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void setGroupName()&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ const string&amp;amp; getGroupDesc();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void setGroupDesc();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void release_resources();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ Device getBoundDeviceid();&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="-396" y="3" width="360" height="587" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-1" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;/p&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;Struct &lt;font color=&quot;#ff0000&quot;&gt;Options&lt;/font&gt;&lt;/b&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ chrono::milliseconds timeout;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ const string backend;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="-420" y="-199.5" width="180" height="70" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-2" value="" style="endArrow=diamondThin;endFill=0;endSize=24;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.177;entryY=0.003;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-1" target="awYpF3qdkxSHiJ_lD2Ai-0">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="-322" y="-40" as="sourcePoint" />
            <mxPoint x="-322" y="50" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-3" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; font-size: 14px; line-height: 19px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;enum&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;BackendType&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; : &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;uint8_t&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; {&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #4fc1ff;&quot;&gt;UNDEFINED&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;0&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #4fc1ff;&quot;&gt;GLOO&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #4fc1ff;&quot;&gt;NCCL&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;2&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #4fc1ff;&quot;&gt;UCC&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;3&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #4fc1ff;&quot;&gt;MPI&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;4&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #4fc1ff;&quot;&gt;CUSTOM&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;5&lt;/span&gt;};&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="-220" y="-244.5" width="230" height="140" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-4" value="" style="endArrow=diamondThin;endFill=0;endSize=24;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.796;entryY=-0.004;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-3" target="awYpF3qdkxSHiJ_lD2Ai-0">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="-110" y="-10" as="sourcePoint" />
            <mxPoint x="50" y="-10" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-5" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Class Backend&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ const int rank_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ const int size_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ string pg_uid_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ string pg_desc_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ shared_ptr&amp;lt;WorkInfo&amp;gt; onCompletionHook_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ optional&amp;lt;Device&amp;gt; bound_device_id_;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void init();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ int64_t getID();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual bool supportingSpliting();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual void &lt;font color=&quot;#0000ff&quot;&gt;startCoalescing&lt;/font&gt;()&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ intrusive_ptr&amp;lt;Work&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;endCoalescing&lt;/font&gt;()&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual c10::intrusive_ptr&amp;lt;Work&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;broadcast/allreduce/&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;&amp;nbsp; &amp;nbsp; allreduce_sparse/allreduce_coalesced/reduce/&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;&amp;nbsp; &amp;nbsp; allgather/_allgather_base/allgather_coalesced/&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;&amp;nbsp; &amp;nbsp; allgather_into_tensor_coalesced/gather/scatter/&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;&amp;nbsp; &amp;nbsp; reduce_scatter/_reduce_scatter_base/&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;&amp;nbsp; &amp;nbsp; reduce_scatter_tensor_coalesced/alltoall_base/&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;&amp;nbsp; &amp;nbsp; alltoall/send/recv/recv/recvAnysource/barrier&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ &lt;/font&gt;&lt;font color=&quot;#0000ff&quot;&gt;...&amp;nbsp; same to ProcessGroup&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#0000ff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ virtual void enableCollectivesTiming()&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ bool setGroupUid(string pg_uid)&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ virtual void eagerConnectSingleDevice(device);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="63" width="300" height="400" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-6" value="" style="endArrow=diamondThin;endFill=0;endSize=24;html=1;rounded=0;exitX=0;exitY=0.25;exitDx=0;exitDy=0;entryX=1.004;entryY=0.169;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-5" target="awYpF3qdkxSHiJ_lD2Ai-0">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="-240" y="-90" as="sourcePoint" />
            <mxPoint x="-80" y="-90" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-7" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;/p&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;Struct&amp;nbsp; &lt;font color=&quot;#ff0000&quot;&gt;Backend::Options&lt;/font&gt;&lt;/b&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ chrono::milliseconds &lt;font color=&quot;#0000ff&quot;&gt;timeout&lt;/font&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ const string &lt;font color=&quot;#0000ff&quot;&gt;backend&lt;/font&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="123" y="-199.5" width="180" height="70" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-8" value="" style="endArrow=diamondThin;endFill=0;endSize=24;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-7" target="awYpF3qdkxSHiJ_lD2Ai-5">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="240" y="10" as="sourcePoint" />
            <mxPoint x="400" y="10" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-9" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Class ProcessGroupNCCL&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ int globalRankStart;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ int globalRankStride;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ static const int64_t kWatchdogThreadSleepMills = 100;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ intrusive_ptr&amp;lt;Store&amp;gt; store_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ intrusive_ptr&amp;lt;Store&amp;gt; globalStore_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ intrusive_ptr&amp;lt;Options&amp;gt; options_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ unorderd_map&amp;lt;string, shared_ptr&amp;lt;&lt;font color=&quot;#cc00cc&quot;&gt;NCCLComm&lt;/font&gt;&amp;gt;&amp;gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&amp;nbsp; &amp;nbsp;devNCCLCommMap_ / inInitializationCommMap_;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ atomic&amp;lt;bool&amp;gt; monitorThreadEnabled_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ atomic&amp;lt;bool&amp;gt; cudaEventCachedEnabled_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ std::thread ncclHeartBetaMonitorThread_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ std::thread ncclCommWatchdogThread_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ std::thread onCompletionHookThread_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ list&amp;lt;&lt;font color=&quot;#ff00ff&quot;&gt;WorkNCCL&lt;/font&gt;&amp;gt; workMetaList_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ unordered_map&amp;lt;string, &lt;font color=&quot;#0000ff&quot;&gt;CUDAStream&lt;/font&gt;&amp;gt; ncclStreams_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ unordered_map&amp;lt;string, &lt;font color=&quot;#0000ff&quot;&gt;CUDAEvent&lt;/font&gt;&amp;gt; ncclEvents_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ static unordered_map&amp;lt;string, ssize_t&amp;gt; pgUniqueNCCLIDCnt_/processGroupCunterMap_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ unordered_set&amp;lt;string&amp;gt; abortedComms_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ static thread_local int64_t ncclActiveGroupCounter_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ int localDeviceCount_{0};&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ shared_ptr&amp;lt;&lt;font color=&quot;#0000cc&quot;&gt;ProcessGroupStatus&lt;/font&gt;&amp;gt; pgStatus_;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#000033&quot;&gt;+&amp;nbsp;&lt;/font&gt;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#0000ff&quot;&gt;...&amp;nbsp; override Backend&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ uint64_t getUid();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ intrusive_ptr&amp;lt;Work&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;endCoalescing&lt;/font&gt;(OpType);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ intrusive_ptr&amp;lt;Work&amp;gt; _broadcast_oop(...);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ intrusive_ptr&amp;lt;Work&amp;gt; _reduce_oop(...);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void groupStart(); // 调用 nccl 里的 ncclGroupStart&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void groupEnd();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void groupEndNonblocking(NCCLComm);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void &lt;font color=&quot;#0000ff&quot;&gt;abortCommsFromMap&lt;/font&gt;(...); // 主动abort&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#ff00ff&quot;&gt;// 提供一个API来中止progress group&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ bool &lt;font color=&quot;#ff00ff&quot;&gt;abort&lt;/font&gt;(abortReason); // 调用abortCommsFromMap&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ intrusive_ptr&amp;lt;IntraNodeComm&amp;gt; initIntraNodeComm();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ void shutdown(reason);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ void eagerConnectSingleDevice(Device);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ void performNocolorSplit(Device);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ void addEphemeralTimeout(timeout);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ bool verifyWorkTimeoutForTest(); // just for test&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ shared_ptr&amp;lt;&lt;/font&gt;&lt;font color=&quot;#0000ff&quot;&gt;NCCLComm&lt;/font&gt;&lt;font color=&quot;#000033&quot;&gt;&amp;gt; getNCCLComm();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ virtual intrusive_ptr&amp;lt;WorkNCCL&amp;gt; initWork();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ intrusive_ptr&amp;lt;Work&amp;gt; collective();&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ intrusive_ptr&amp;lt;Work&amp;gt; pointToPoint();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ intrusive_ptr&amp;lt;Work&amp;gt; &lt;/font&gt;&lt;font color=&quot;#0000ff&quot;&gt;allreduce_impl&lt;/font&gt;&lt;font color=&quot;#000033&quot;&gt;();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void destroyNCCLComms();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void watchdogHandler();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void runHookLoop();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ const int&amp;amp; globalRank();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ const vector&amp;lt;uint64_t&amp;gt; groupRanks();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void assignTimeoutToWork(...);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ virtual void heartbeatMonitor();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ virtual void terminateProcess(errMsg);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ void waitForFutureOrTimeout();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ virtual string getNCCLWathchdogDebugInfo();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ string getNCCLWatchdogTimeoutErrorMsg();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ string getNCCLWatchdogTimeoutExitMsg();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font color=&quot;#000033&quot;&gt;+ void workEnqueue(WorkNCCL);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="520" y="-16" width="320" height="870" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-10" value="Extends" style="endArrow=block;endSize=16;endFill=0;html=1;rounded=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;exitX=0;exitY=0.25;exitDx=0;exitDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-9" target="awYpF3qdkxSHiJ_lD2Ai-5">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="460" y="120" as="sourcePoint" />
            <mxPoint x="510" y="-30" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-11" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;/p&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;struct&lt;font color=&quot;#ff0000&quot;&gt; ProcessGroupNCCL::Options&lt;/font&gt;&lt;/b&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ bool &lt;font color=&quot;#0000ff&quot;&gt;is_high_priority_stream&lt;/font&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ shared_ptr&amp;lt;ProcessGroupNCCL&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;split_from&lt;/font&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ int64_t &lt;font color=&quot;#0000ff&quot;&gt;split_color&lt;/font&gt;{0};&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ vector&amp;lt;uint64_6&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;global_ranks_in_group&lt;/font&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ string &lt;font color=&quot;#0000ff&quot;&gt;group_name&lt;/font&gt;;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ intrusive_ptr&amp;lt;Options&amp;gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;create(is_high_priority_stream);&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="430" y="-244.5" width="260" height="155" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-12" value="Extends" style="endArrow=block;endSize=16;endFill=0;html=1;rounded=0;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-11" target="awYpF3qdkxSHiJ_lD2Ai-7">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="220" y="-270" as="sourcePoint" />
            <mxPoint x="380" y="-270" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-13" value="" style="endArrow=diamondThin;endFill=0;endSize=24;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.25;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-11" target="awYpF3qdkxSHiJ_lD2Ai-9">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="460" as="sourcePoint" />
            <mxPoint x="620" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-14" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;/p&gt;&lt;b&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;struct&lt;font color=&quot;#ff0000&quot;&gt;&amp;nbsp;CUDAEventCache&lt;/font&gt;&lt;/b&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ std::mutex cacheMutex_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ vector&amp;lt;at::cuda::CUDAEvent*&amp;gt; eventsArray_[2];&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ shared_ptr&amp;lt;at::cuda::CUDAEvent&amp;gt; create(timing);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ static CUDAEventCache&amp;amp; get();&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="700" y="-199.5" width="290" height="110" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-15" value="" style="endArrow=diamondThin;endFill=0;endSize=24;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.75;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-14" target="awYpF3qdkxSHiJ_lD2Ai-9">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="780" y="-10" as="sourcePoint" />
            <mxPoint x="940" y="-10" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-16" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;/p&gt;&lt;b&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;struct&lt;font color=&quot;#ff0000&quot;&gt;&amp;nbsp;Work&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;/b&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ mutable std::mutex mutex_;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ std::condition_variable cv_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ bool completed_ = false;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ const int rank_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ OpType opType_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ std::function&amp;lt;void()&amp;gt; recordFunctionEndCallback_;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual bool isCompleted();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual bool isSuccess();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual int sourceRank();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual vector&amp;lt;Tensor&amp;gt; result();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual bool synchronize();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual bool wait();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual void &lt;font color=&quot;#0000ff&quot;&gt;abort&lt;/font&gt;();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual intrusive_ptr&amp;lt;&lt;font color=&quot;#0000ff&quot;&gt;Future&lt;/font&gt;&amp;gt; getFuture();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual float getDuration();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ virtual uint64_t getSequencenumber();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ OpType retrieveOptype();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ static intrusive_ptr&amp;lt;Work&amp;gt; create_from_future(Future);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void finish()&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void finishAndThrow(exception_ptr);&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="1450" y="-16" width="320" height="343" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-17" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;/p&gt;&lt;b&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;Struct&amp;nbsp; &lt;font color=&quot;#ff0000&quot;&gt;WorkInfo&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;/b&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ OpType opType;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ uint64_t seq;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ chrono::time_point&amp;lt;chrono::system_clock&amp;gt;&amp;nbsp;&lt;font color=&quot;#0000ff&quot;&gt;timeStarted&lt;/font&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ chrono::time_point&amp;lt;chrono::system_clock&amp;gt;&amp;nbsp;&lt;font style=&quot;border-color: var(--border-color);&quot; color=&quot;#0000ff&quot;&gt;timeFinished&lt;/font&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ chrono::duration&amp;lt;fload&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;activeDuration&lt;/font&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="43" y="450" width="340" height="110" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-18" value="" style="endArrow=diamondThin;endFill=0;endSize=24;html=1;rounded=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-17" target="awYpF3qdkxSHiJ_lD2Ai-5">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="640" y="500" as="sourcePoint" />
            <mxPoint x="800" y="500" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-19" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;/p&gt;&lt;b&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;struct&lt;font color=&quot;#ff0000&quot;&gt;&amp;nbsp;WorkNCCL&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;/b&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ string pgUID_;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ string pgDesc_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ Device device_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ shared_ptr&amp;lt;CUDAEvent&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;ncclStartEvent_&lt;/font&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ shared_ptr&amp;lt;CUDAEvent&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;ncclEndEvent_&lt;/font&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ shared_ptr&amp;lt;NCCLComm&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;ncclComm_&lt;/font&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ at::Tensor barrierTensor_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ bool blockingWait_ = false;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ bool avoidRecordStreams_=false // clone from PGNCCL&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ chrono::milliseconds opTimeout_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ownedEphermeralTimeout_ = chrono::milliseconds(0);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ time_point&amp;lt;chrono::steady_clock&amp;gt; workStartTime_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ uint64_t seq_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ bool startTraceUpdated_{false};&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ size_t numelln_ = -1;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ size_t numelOut_ = -1;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ intrusive_ptr&amp;lt;&lt;font color=&quot;#0000ff&quot;&gt;Store&lt;/font&gt;&amp;gt; store_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ shared_ptr&amp;lt;vector&amp;lt;at::Tensor&amp;gt;&amp;gt; outputs_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ shared_ptr&amp;lt;vector&amp;lt;Tensor&amp;gt;&amp;gt; stashed_for_allocator_safety_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ intrusive_ptr&amp;lt;&lt;font color=&quot;#0000ff&quot;&gt;Future&lt;/font&gt;&amp;gt; future_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ bool timingEnabled_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ optional&amp;lt;uint64_t&amp;gt; trace_id_;&amp;nbsp;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&amp;nbsp;+ &lt;font color=&quot;#0000ff&quot;&gt;...&amp;nbsp; override baseclass Work&lt;/font&gt;&lt;br&gt;&amp;nbsp;+ bool isStarted();&lt;br&gt;&amp;nbsp;+ void &lt;font color=&quot;#0000ff&quot;&gt;synchronizeStream&lt;/font&gt;();&lt;br&gt;&amp;nbsp;+ void handleException();&lt;br&gt;&amp;nbsp;+ bool &lt;font color=&quot;#0000ff&quot;&gt;finishedGPUExecution&lt;/font&gt;();&lt;br&gt;&amp;nbsp;+ void setException();&lt;br&gt;&amp;nbsp;+ bool checkTimeout();&lt;br&gt;&amp;nbsp;+ vector&amp;lt;Tensor&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;result&lt;/font&gt;();&lt;br&gt;&lt;p style=&quot;border-color: var(--border-color); margin-top: 0px; margin-bottom: 0px; margin-left: 4px;&quot;&gt;+ synchronizeInternal(milliseconds timeout);&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin-top: 0px; margin-bottom: 0px; margin-left: 4px;&quot;&gt;+ void checkAndSetException();&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin-top: 0px; margin-bottom: 0px; margin-left: 4px;&quot;&gt;+ bool startedGPUExecutionInternal(); # just checks&lt;/p&gt;&lt;p style=&quot;border-color: var(--border-color); margin-top: 0px; margin-bottom: 0px; margin-left: 4px;&quot;&gt;+ bool finishedGPUExecutionInternal(); # just checks&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="950" y="-16" width="370" height="544.5" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-20" value="Extends" style="endArrow=block;endSize=16;endFill=0;html=1;rounded=0;exitX=1.007;exitY=0.318;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitPerimeter=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-19" target="awYpF3qdkxSHiJ_lD2Ai-16">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="1290" y="154" as="sourcePoint" />
            <mxPoint x="1450" y="154" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-21" value="" style="endArrow=diamondThin;endFill=0;endSize=24;html=1;rounded=0;exitX=0;exitY=0.25;exitDx=0;exitDy=0;entryX=1.008;entryY=0.206;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-19">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="710" y="134" as="sourcePoint" />
            <mxPoint x="842.56" y="119.95999999999981" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-22" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;/p&gt;&lt;b&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;b style=&quot;background-color: initial;&quot;&gt;class NCCLComm&lt;/b&gt;&lt;/div&gt;&lt;/b&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ncclComm_t ncclComm_; // nccl 库中定义的&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ &lt;font color=&quot;#0000ff&quot;&gt;ncclUniqueId &lt;/font&gt;ncclId_; // char internal[128]&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ bool &lt;font color=&quot;#0000ff&quot;&gt;aborted_&lt;/font&gt;;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ uint64_t &lt;font color=&quot;#0000ff&quot;&gt;ncclCommSplitCounter_&lt;/font&gt;{0};&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ncclResult_t ncclAsynErr_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ int rank_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ string commFailureReason_;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ bool initialized_{false};&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ unordered_map&amp;lt;void*, void*&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;registeredSegmentHandles_&lt;/font&gt;;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ static shared_ptr&amp;lt;NCCLComm&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;create&lt;/font&gt;(numRanks, rank,&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;ncclUniqueId, ncclConfig_t);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ static shared_ptr&amp;lt;NCCLComm&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;split&lt;/font&gt;(NCCLComm*, ...);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ncclComm_t &lt;font color=&quot;#0000ff&quot;&gt;getNcclComm&lt;/font&gt;();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ string getNcclCommFailureReason();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void &lt;font color=&quot;#0000ff&quot;&gt;ncclCommAbort&lt;/font&gt;();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ bool &lt;font color=&quot;#0000ff&quot;&gt;isAborted&lt;/font&gt;();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ncclResult_t checkForNcclError();&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ncclResult &lt;font color=&quot;#0000ff&quot;&gt;registerSegment&lt;/font&gt;(void* ptr, size) // ncclCommRegister&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ncclResult &lt;font color=&quot;#0000ff&quot;&gt;deregisterSegment&lt;/font&gt;(void* ptr);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ &lt;font color=&quot;#0000ff&quot;&gt;waitUntilInitialized&lt;/font&gt;(int timeoutSecs);&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="955" y="610" width="360" height="340" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-23" value="" style="endArrow=diamondThin;endFill=0;endSize=24;html=1;rounded=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-22" target="awYpF3qdkxSHiJ_lD2Ai-19">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="1210" y="570" as="sourcePoint" />
            <mxPoint x="1370" y="570" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-24" value="" style="endArrow=diamondThin;endFill=0;endSize=24;html=1;rounded=0;entryX=1.003;entryY=0.819;entryDx=0;entryDy=0;exitX=0;exitY=0.25;exitDx=0;exitDy=0;entryPerimeter=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-22" target="awYpF3qdkxSHiJ_lD2Ai-9">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="1000" y="560" as="sourcePoint" />
            <mxPoint x="1160" y="560" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-25" value="&lt;div style=&quot;color: rgb(204, 204, 204); background-color: rgb(31, 31, 31); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-weight: normal; line-height: 128%;&quot;&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;// process group 的最新状态.&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;struct&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;ProcessGroupStatus&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;&amp;nbsp; //最后入队的集体操作的序列号&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;int64_t&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; lastEnqueuedSeq{&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;};&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;&amp;nbsp; //作为kernel启动的最后一个集体操作的序列号&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;int64_t&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; lastStartedSeq{&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;};&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;&amp;nbsp; //由watchdog 标记的最后一个已完成的集体操作的序列号&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;int64_t&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; lastCompletedSeq{&lt;/span&gt;&lt;span style=&quot;color: #d4d4d4;&quot;&gt;-&lt;/span&gt;&lt;span style=&quot;color: #b5cea8;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;};&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;&amp;nbsp; //最后入队workMetaList_的collective名称&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;std&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;::string lastEnqueuedWorkName;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;&amp;nbsp; //最后启动kernel的collective的名称&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;std&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;::string lastStartedWorkName;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;&amp;nbsp; //已完成的最后一个collective的名称&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #4ec9b0;&quot;&gt;std&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;::string lastCompletedWorkName;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;&amp;nbsp; // 最后入队的work的大小&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;size_t&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; lastEnqueuedNumelIn;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;size_t&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; lastEnqueuedNumelOut;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #6a9955;&quot;&gt;&amp;nbsp; // 最后完成的work的大小&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;size_t&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; lastCompletedNumelIn;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #569cd6;&quot;&gt;size_t&lt;/span&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt; lastCompletedNumelOut;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;line-height: 128%;&quot;&gt;&lt;span style=&quot;color: #cccccc;&quot;&gt;};&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="text;whiteSpace=wrap;html=1;spacing=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="38" y="610" width="350" height="360" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-26" value="" style="endArrow=diamondThin;endFill=0;endSize=24;html=1;rounded=0;exitX=1;exitY=0.25;exitDx=0;exitDy=0;entryX=-0.006;entryY=0.824;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-25" target="awYpF3qdkxSHiJ_lD2Ai-9">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="440" y="690" as="sourcePoint" />
            <mxPoint x="600" y="690" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-27" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Class GroupRegistry&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ &lt;font color=&quot;#7f00ff&quot;&gt;std::map&amp;lt;string, weak_intrusive_ptr&amp;lt;ProcessGroup&amp;gt;&amp;gt; registry_;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void &lt;font color=&quot;#0000ff&quot;&gt;register_group&lt;/font&gt;(group_name, intrusive_ptr&amp;lt;Processgroup&amp;gt;);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ intrusive_ptr&amp;lt;ProcessGroup&amp;gt; &lt;font color=&quot;#0000ff&quot;&gt;resolve_group&lt;/font&gt;(group_name);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void &lt;font color=&quot;#0000ff&quot;&gt;unregister_group&lt;/font&gt;(string&amp;amp; group_name);&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ void &lt;font color=&quot;#0000ff&quot;&gt;unregister_all_groups&lt;/font&gt;();&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="-401" y="680" width="370" height="130" as="geometry" />
        </mxCell>
        <mxCell id="awYpF3qdkxSHiJ_lD2Ai-28" value="n" style="endArrow=open;html=1;endSize=12;startArrow=diamondThin;startSize=14;startFill=0;edgeStyle=orthogonalEdgeStyle;align=left;verticalAlign=bottom;rounded=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="WIyWlLk6GJQsqaUBKTNV-1" source="awYpF3qdkxSHiJ_lD2Ai-27" target="awYpF3qdkxSHiJ_lD2Ai-0">
          <mxGeometry x="-0.8131" y="14" relative="1" as="geometry">
            <mxPoint x="-140" y="620" as="sourcePoint" />
            <mxPoint x="20" y="620" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
